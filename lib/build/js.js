// Generated by CoffeeScript 2.5.1
(function() {
  var YAML, buildDeps, buildScripts, buildWorkers, coffee, ensureDirExists, existsSync, failIfDirNotExists, handleWebpackErrors, path, readFileSync, runWebpack, webpack, writeFileSync;

  ({readFileSync, writeFileSync, existsSync} = require('fs'));

  path = require('path');

  webpack = require('webpack');

  YAML = require('yaml');

  coffee = require('coffeescript');

  ({failIfDirNotExists, ensureDirExists} = require('../util'));

  handleWebpackErrors = function(error, stats) {
    var info;
    if (error) {
      console.error(error.stack || error);
      if (error.details) {
        console.error(error.details);
      }
      return;
    }
    info = stats.toJson();
    if (stats.hasErrors()) {
      console.error(info.errors);
    }
    if (stats.hasWarnings()) {
      return console.warn(info.warnings);
    }
  };

  runWebpack = function({entry, output}) {
    var conf, dir, load_coffee, name;
    dir = path.dirname(output);
    name = path.basename(output);
    load_coffee = {
      test: /\.coffee$/,
      use: 'coffee-loader'
    };
    conf = {
      mode: 'production',
      entry: entry,
      output: {
        path: dir,
        filename: name
      },
      module: {
        rules: [load_coffee]
      }
    };
    return webpack(conf, handleWebpackErrors);
  };

  buildDeps = function() {
    var entry, file, generateWebpackEntry, spec, targetDir;
    file = `${SRC}/deps.yml`;
    if (existsSync(file)) {
      spec = YAML.parse(readFileSync(file, 'utf-8'));
      generateWebpackEntry = function(spec) {
        var entry, source;
        ensureDirExists('/tmp/makepwa');
        entry = '/tmp/makepwa/deps.js';
        console.log(spec);
        source = "console.log 'dependencies will be here'";
        writeFileSync(entry, coffee.compile(source));
        return entry;
      };
      targetDir = `${DIST}/scripts`;
      ensureDirExists(targetDir);
      entry = generateWebpackEntry(spec);
      return runWebpack({
        entry,
        output: `${targetDir}/deps.js`
      });
    }
  };

  buildScripts = function() {
    var sourceDir, targetDir;
    sourceDir = `${SRC}/scripts`;
    failIfDirNotExists(sourceDir);
    targetDir = `${DIST}/scripts`;
    ensureDirExists(targetDir);
    return runWebpack({
      entry: `${sourceDir}/main.coffee`,
      output: `${targetDir}/main.js`
    });
  };

  buildWorkers = function() {
    var sourceDir;
    sourceDir = `${SRC}/workers`;
    failIfDirNotExists(sourceDir);
    return runWebpack({
      entry: `${sourceDir}/sw.coffee`,
      output: `${DIST}/sw.js`
    });
  };

  module.exports = {buildDeps, buildScripts, buildWorkers};

}).call(this);
